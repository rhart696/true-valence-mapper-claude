name: Security Audit

on:
  schedule:
    # Run weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:
  pull_request:
    paths:
      - '**.js'
      - '**.html'
      - '**.sql'

concurrency:
  group: security-audit-${{ github.ref }}
  cancel-in-progress: true

jobs:
  security-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Check for hardcoded secrets
        run: |
          echo "üîç Scanning for hardcoded secrets in v1/src/..."
          SCAN_DIR="v1/src"

          # Check for common secret patterns
          if grep -rEi "password\s*=\s*['\"]" --include="*.ts" --include="*.tsx" "$SCAN_DIR"; then
            echo "‚ö†Ô∏è WARNING: Found potential hardcoded passwords"
            exit 1
          fi

          if grep -rEi "api[_-]?key\s*=\s*['\"][^'\"]{20,}" --include="*.ts" --include="*.tsx" "$SCAN_DIR"; then
            echo "‚ö†Ô∏è WARNING: Found potential hardcoded API keys"
            exit 1
          fi

          if grep -rEi "secret\s*=\s*['\"]" --include="*.ts" --include="*.tsx" "$SCAN_DIR"; then
            echo "‚ö†Ô∏è WARNING: Found potential hardcoded secrets"
            exit 1
          fi

          echo "‚úÖ No hardcoded secrets detected"

      - name: Check SQL injection patterns
        run: |
          echo "üîç Scanning SQL files for injection risks..."

          # Check for SQL files with potential injection patterns
          if find docs/ -name "*.sql" -type f 2>/dev/null | xargs grep -i "DROP TABLE" 2>/dev/null | grep -v "IF EXISTS" | grep -v "-- "; then
            echo "‚ö†Ô∏è WARNING: Found potentially unsafe DROP TABLE statements"
            exit 1
          fi

          # Check for string concatenation in SQL (indicates potential injection)
          if grep -rEi "\+\s*['\"].*SELECT" --include="*.ts" --include="*.tsx" v1/src/; then
            echo "‚ö†Ô∏è WARNING: Found potential SQL injection via string concatenation"
            exit 1
          fi

          echo "‚úÖ No SQL injection patterns detected"

      - name: Check XSS vulnerabilities
        run: |
          echo "üîç Scanning v1/src/ for XSS vulnerability patterns..."

          # Check for dangerous innerHTML usage in TS/TSX files
          if grep -rn "innerHTML\s*=" --include="*.ts" --include="*.tsx" v1/src/ | grep -v "dangerouslySetInnerHTML"; then
            echo "‚ö†Ô∏è WARNING: Found potentially unsafe innerHTML usage"
            exit 1
          fi

          # Check for eval usage
          if grep -rn "eval(" --include="*.ts" --include="*.tsx" v1/src/; then
            echo "‚ö†Ô∏è WARNING: Found eval() usage (dangerous)"
            exit 1
          fi

          # Check for new Function usage
          if grep -rn "new Function(" --include="*.ts" --include="*.tsx" v1/src/; then
            echo "‚ö†Ô∏è WARNING: Found new Function() usage (dangerous)"
            exit 1
          fi

          echo "‚úÖ No XSS vulnerability patterns detected"

      - name: Validate input sanitization
        run: |
          echo "üîç Checking for proper input validation in v1/src/..."

          # v1 uses Supabase client + TypeScript types for validation ‚Äî check that
          # user-facing inputs go through the lib/supabase.ts abstraction layer
          if ! grep -rq "supabase\|sanitize\|validate\|maxLength\|trim()" v1/src/components/; then
            echo "‚ö†Ô∏è WARNING: No input sanitization patterns found in v1/src/components/"
            exit 1
          fi

          echo "‚úÖ Input validation checks passed"

      - name: Check RLS policies
        run: |
          echo "üîç Validating RLS policy security in docs/..."

          # Check if SQL files contain RLS policies
          if find docs/ -name "*rls*.sql" -type f 2>/dev/null | xargs grep -i "CREATE POLICY" 2>/dev/null | grep -v "USING"; then
            echo "‚ö†Ô∏è WARNING: Found RLS policy without USING clause"
            exit 1
          fi

          # Check for permissive policies (allow all)
          if find docs/ -name "*.sql" -type f 2>/dev/null | xargs grep -i "TO authenticated" 2>/dev/null | grep -i "USING (true)"; then
            echo "‚ö†Ô∏è WARNING: Found overly permissive RLS policy"
            exit 1
          fi

          echo "‚úÖ RLS policy checks passed"

      - name: Security audit summary
        if: always()
        run: |
          echo "üìä Security Audit Summary"
          echo "========================"
          echo ""
          echo "Checks performed:"
          echo "  ‚úì Hardcoded secrets scan"
          echo "  ‚úì SQL injection patterns"
          echo "  ‚úì XSS vulnerability patterns"
          echo "  ‚úì Input validation usage"
          echo "  ‚úì RLS policy validation"
          echo ""
          echo "For detailed security documentation, see:"
          echo "  - .github/SECURITY.md"
          echo "  - docs/security/"

      - name: Upload audit results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-results
          path: |
            **/*.sql
            **/*.js
            **/*.html
          retention-days: 30
