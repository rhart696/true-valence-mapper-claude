<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anonymous Auth Test Suite</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-suite {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 10px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border-left: 4px solid #2196F3;
            background: #f9f9f9;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .pass {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .fail {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .pending {
            background: #fff3cd;
            border: 1px solid #ffeeba;
            color: #856404;
        }
        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        #console-output {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin: 20px 0;
        }
        .summary {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="test-suite">
        <h1>üß™ Anonymous Auth Test Suite</h1>
        <p>Comprehensive testing for Supabase anonymous authentication implementation</p>

        <div class="test-section">
            <h2>Test Controls</h2>
            <button onclick="runAllTests()">‚ñ∂Ô∏è Run All Tests</button>
            <button onclick="runAuthTests()">üîê Test Auth Only</button>
            <button onclick="runCRUDTests()">üíæ Test CRUD Only</button>
            <button onclick="runRLSTests()">üîí Test RLS Only</button>
            <button onclick="clearResults()">üóëÔ∏è Clear Results</button>
            <button onclick="clearLocalStorage()">‚ö†Ô∏è Clear Storage</button>
        </div>

        <div id="results"></div>

        <div class="summary" id="summary" style="display:none;">
            <div id="summary-content"></div>
        </div>

        <div class="test-section">
            <h2>Console Output</h2>
            <div id="console-output"></div>
        </div>
    </div>

    <!-- Load dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="toast-notifications.js"></script>
    <script src="input-validation.js"></script>
    <script src="cloud-storage.js"></script>

    <script>
        // Test framework
        class TestRunner {
            constructor() {
                this.results = [];
                this.cloudStorage = null;
            }

            log(message, type = 'info') {
                const consoleDiv = document.getElementById('console-output');
                const timestamp = new Date().toLocaleTimeString();
                const color = {
                    info: '#d4d4d4',
                    success: '#4ec9b0',
                    error: '#f48771',
                    warning: '#dcdcaa'
                }[type] || '#d4d4d4';

                consoleDiv.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span>\n`;
                consoleDiv.scrollTop = consoleDiv.scrollHeight;
            }

            addResult(testName, passed, message) {
                this.results.push({ testName, passed, message });

                const resultsDiv = document.getElementById('results');
                const resultDiv = document.createElement('div');
                resultDiv.className = `test-result ${passed ? 'pass' : 'fail'}`;
                resultDiv.innerHTML = `
                    <strong>${passed ? '‚úÖ' : '‚ùå'} ${testName}</strong><br>
                    ${message}
                `;
                resultsDiv.appendChild(resultDiv);
            }

            async sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            showSummary() {
                const total = this.results.length;
                const passed = this.results.filter(r => r.passed).length;
                const failed = total - passed;

                const summaryDiv = document.getElementById('summary');
                const contentDiv = document.getElementById('summary-content');

                summaryDiv.style.display = 'block';
                contentDiv.innerHTML = `
                    üìä Test Summary: ${passed}/${total} tests passed (${failed} failed)
                `;
            }

            // Test 1: Auth Initialization
            async testAuthInitialization() {
                this.log('üîê Testing auth initialization...', 'info');

                try {
                    this.cloudStorage = new CloudStorage();

                    // Wait for auth to complete
                    await this.sleep(2000);

                    if (!this.cloudStorage.authInitialized) {
                        throw new Error('Auth not initialized after 2 seconds');
                    }

                    if (!this.cloudStorage.deviceId) {
                        throw new Error('Device ID not set');
                    }

                    const uuidPattern = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
                    if (!uuidPattern.test(this.cloudStorage.deviceId)) {
                        throw new Error('Device ID is not a valid UUID');
                    }

                    this.log(`‚úÖ Auth initialized with device_id: ${this.cloudStorage.deviceId}`, 'success');
                    this.addResult(
                        'Auth Initialization',
                        true,
                        `Successfully initialized with device_id: ${this.cloudStorage.deviceId.substring(0, 8)}...`
                    );
                } catch (error) {
                    this.log(`‚ùå Auth initialization failed: ${error.message}`, 'error');
                    this.addResult('Auth Initialization', false, error.message);
                }
            }

            // Test 2: Session Persistence
            async testSessionPersistence() {
                this.log('üîÑ Testing session persistence...', 'info');

                try {
                    const deviceId1 = this.cloudStorage.deviceId;

                    // Create second instance (simulates page reload)
                    const cloudStorage2 = new CloudStorage();
                    await this.sleep(2000);

                    const deviceId2 = cloudStorage2.deviceId;

                    if (deviceId1 !== deviceId2) {
                        throw new Error(`Device IDs don't match: ${deviceId1} vs ${deviceId2}`);
                    }

                    this.log('‚úÖ Session persists across instances', 'success');
                    this.addResult(
                        'Session Persistence',
                        true,
                        'Device ID remains consistent across CloudStorage instances'
                    );
                } catch (error) {
                    this.log(`‚ùå Session persistence failed: ${error.message}`, 'error');
                    this.addResult('Session Persistence', false, error.message);
                }
            }

            // Test 3: Save to Cloud
            async testSaveToCloud() {
                this.log('üíæ Testing save to cloud...', 'info');

                try {
                    const testMapData = {
                        relationships: [
                            { id: 1, name: 'Test Person', x: 100, y: 100 }
                        ],
                        trustScores: {
                            1: { outward: 1, inward: 2 }
                        }
                    };

                    const result = await this.cloudStorage.saveToCloud(testMapData, 'Test Map');

                    if (!result.success) {
                        throw new Error('Save operation failed');
                    }

                    if (!result.id) {
                        throw new Error('No map ID returned');
                    }

                    if (!result.shareCode) {
                        throw new Error('No share code returned');
                    }

                    this.log(`‚úÖ Map saved with ID: ${result.id}`, 'success');
                    this.addResult(
                        'Save to Cloud',
                        true,
                        `Map saved successfully. ID: ${result.id}, Share Code: ${result.shareCode}`
                    );

                    // Store for later tests
                    this.testMapId = result.id;
                    this.testShareCode = result.shareCode;

                } catch (error) {
                    this.log(`‚ùå Save to cloud failed: ${error.message}`, 'error');
                    this.addResult('Save to Cloud', false, error.message);
                }
            }

            // Test 4: Load from Cloud
            async testLoadFromCloud() {
                this.log('üì• Testing load from cloud...', 'info');

                try {
                    if (!this.testMapId) {
                        throw new Error('No test map ID available (save test may have failed)');
                    }

                    const result = await this.cloudStorage.loadFromCloud(this.testMapId);

                    if (!result.success) {
                        throw new Error('Load operation failed');
                    }

                    if (!result.data || !result.data.relationships) {
                        throw new Error('Map data not returned');
                    }

                    if (result.data.relationships.length !== 1) {
                        throw new Error('Incorrect number of relationships');
                    }

                    if (result.data.relationships[0].name !== 'Test Person') {
                        throw new Error('Incorrect relationship data');
                    }

                    this.log('‚úÖ Map loaded successfully', 'success');
                    this.addResult(
                        'Load from Cloud',
                        true,
                        'Map loaded with correct data'
                    );

                } catch (error) {
                    this.log(`‚ùå Load from cloud failed: ${error.message}`, 'error');
                    this.addResult('Load from Cloud', false, error.message);
                }
            }

            // Test 5: Get My Maps
            async testGetMyMaps() {
                this.log('üìã Testing get my maps...', 'info');

                try {
                    const result = await this.cloudStorage.getMyMaps();

                    if (!result.success) {
                        throw new Error('Get maps operation failed');
                    }

                    if (!result.maps || !Array.isArray(result.maps)) {
                        throw new Error('Maps array not returned');
                    }

                    if (result.maps.length === 0) {
                        throw new Error('No maps returned (should have at least test map)');
                    }

                    const testMap = result.maps.find(m => m.id === this.testMapId);
                    if (!testMap) {
                        throw new Error('Test map not found in user maps');
                    }

                    this.log(`‚úÖ Found ${result.maps.length} map(s)`, 'success');
                    this.addResult(
                        'Get My Maps',
                        true,
                        `Retrieved ${result.maps.length} map(s) successfully`
                    );

                } catch (error) {
                    this.log(`‚ùå Get my maps failed: ${error.message}`, 'error');
                    this.addResult('Get My Maps', false, error.message);
                }
            }

            // Test 6: Share Code Access
            async testShareCodeAccess() {
                this.log('üîó Testing share code access...', 'info');

                try {
                    if (!this.testShareCode) {
                        throw new Error('No test share code available');
                    }

                    // Create new CloudStorage instance (simulates different user)
                    const otherUser = new CloudStorage();
                    await this.sleep(2000);

                    const result = await otherUser.loadFromCloud(this.testShareCode);

                    if (!result.success) {
                        throw new Error('Share code load failed');
                    }

                    if (!result.data || !result.data.relationships) {
                        throw new Error('Shared map data not returned');
                    }

                    this.log('‚úÖ Share code access works', 'success');
                    this.addResult(
                        'Share Code Access',
                        true,
                        'Different user can access map via share code'
                    );

                } catch (error) {
                    this.log(`‚ùå Share code access failed: ${error.message}`, 'error');
                    this.addResult('Share Code Access', false, error.message);
                }
            }

            // Test 7: RLS User Isolation
            async testRLSUserIsolation() {
                this.log('üîí Testing RLS user isolation...', 'info');

                try {
                    // Create second user
                    localStorage.removeItem('sb-qhozgoiukkbwjivowrbw-auth-token');
                    const user2 = new CloudStorage();
                    await this.sleep(2000);

                    // User 2 tries to get all maps
                    const result = await user2.getMyMaps();

                    if (!result.success) {
                        throw new Error('Get maps failed for user2');
                    }

                    // User 2 should not see User 1's maps
                    const hasUser1Maps = result.maps.some(m => m.id === this.testMapId);

                    if (hasUser1Maps) {
                        throw new Error('‚ùå SECURITY VIOLATION: User 2 can see User 1 maps!');
                    }

                    this.log('‚úÖ RLS enforces user isolation', 'success');
                    this.addResult(
                        'RLS User Isolation',
                        true,
                        'Users cannot see each other\'s maps'
                    );

                } catch (error) {
                    this.log(`‚ùå RLS user isolation test failed: ${error.message}`, 'error');
                    this.addResult('RLS User Isolation', false, error.message);
                }
            }

            // Test 8: Delete Map
            async testDeleteMap() {
                this.log('üóëÔ∏è Testing delete map...', 'info');

                try {
                    if (!this.testMapId) {
                        throw new Error('No test map ID available');
                    }

                    const result = await this.cloudStorage.deleteMap(this.testMapId);

                    if (!result.success) {
                        throw new Error('Delete operation failed');
                    }

                    // Verify deletion
                    const maps = await this.cloudStorage.getMyMaps();
                    const stillExists = maps.maps.some(m => m.id === this.testMapId);

                    if (stillExists) {
                        throw new Error('Map still exists after deletion');
                    }

                    this.log('‚úÖ Map deleted successfully', 'success');
                    this.addResult(
                        'Delete Map',
                        true,
                        'Map deleted and verified removed'
                    );

                } catch (error) {
                    this.log(`‚ùå Delete map failed: ${error.message}`, 'error');
                    this.addResult('Delete Map', false, error.message);
                }
            }

            // Run all tests
            async runAll() {
                this.results = [];
                document.getElementById('results').innerHTML = '';
                document.getElementById('console-output').innerHTML = '';
                document.getElementById('summary').style.display = 'none';

                this.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
                this.log('üß™ STARTING TEST SUITE', 'info');
                this.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');

                await this.testAuthInitialization();
                await this.sleep(1000);

                await this.testSessionPersistence();
                await this.sleep(1000);

                await this.testSaveToCloud();
                await this.sleep(1000);

                await this.testLoadFromCloud();
                await this.sleep(1000);

                await this.testGetMyMaps();
                await this.sleep(1000);

                await this.testShareCodeAccess();
                await this.sleep(1000);

                await this.testRLSUserIsolation();
                await this.sleep(1000);

                await this.testDeleteMap();
                await this.sleep(1000);

                this.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
                this.log('‚úÖ TEST SUITE COMPLETE', 'success');
                this.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');

                this.showSummary();
            }
        }

        const testRunner = new TestRunner();

        function runAllTests() {
            testRunner.runAll();
        }

        function runAuthTests() {
            testRunner.results = [];
            document.getElementById('results').innerHTML = '';
            testRunner.testAuthInitialization();
            setTimeout(() => testRunner.testSessionPersistence(), 3000);
        }

        function runCRUDTests() {
            testRunner.results = [];
            document.getElementById('results').innerHTML = '';
            testRunner.testSaveToCloud();
            setTimeout(() => testRunner.testLoadFromCloud(), 2000);
            setTimeout(() => testRunner.testGetMyMaps(), 4000);
        }

        function runRLSTests() {
            testRunner.results = [];
            document.getElementById('results').innerHTML = '';
            testRunner.testRLSUserIsolation();
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            document.getElementById('console-output').innerHTML = '';
            document.getElementById('summary').style.display = 'none';
            testRunner.results = [];
        }

        function clearLocalStorage() {
            if (confirm('This will clear all localStorage including auth session. Continue?')) {
                localStorage.clear();
                location.reload();
            }
        }
    </script>
</body>
</html>
