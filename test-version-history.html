<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Version History Test Suite</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .test-pass {
            background: #d4edda;
            border-left: 4px solid #28a745;
            color: #155724;
        }
        .test-fail {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
            color: #721c24;
        }
        button {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        h1 { color: #2E4A8B; }
        h2 { color: #00A8CC; }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>Version History Test Suite</h1>
    <p>This page tests the version history functionality for the True Valence Mapper.</p>

    <div class="test-section">
        <h2>Quick Actions</h2>
        <button onclick="runAllTests()">Run All Tests</button>
        <button onclick="clearResults()">Clear Results</button>
        <button onclick="clearStorage()">Clear Storage</button>
    </div>

    <div id="results"></div>

    <script src="input-validation.js"></script>
    <script src="version-history.js"></script>
    <script>
        let testResults = [];

        // Test helper functions
        function assert(condition, message) {
            if (condition) {
                testResults.push({ pass: true, message });
            } else {
                testResults.push({ pass: false, message });
            }
        }

        function assertEquals(actual, expected, message) {
            if (actual === expected) {
                testResults.push({ pass: true, message: `${message} (${actual})` });
            } else {
                testResults.push({
                    pass: false,
                    message: `${message} - Expected: ${expected}, Got: ${actual}`
                });
            }
        }

        function displayResults() {
            const resultsDiv = document.getElementById('results');
            const passed = testResults.filter(r => r.pass).length;
            const failed = testResults.filter(r => !r.pass).length;

            let html = `
                <div class="test-section">
                    <h2>Test Results: ${passed} passed, ${failed} failed</h2>
                    ${testResults.map(r => `
                        <div class="test-result ${r.pass ? 'test-pass' : 'test-fail'}">
                            ${r.pass ? '✓' : '✗'} ${r.message}
                        </div>
                    `).join('')}
                </div>
            `;

            resultsDiv.innerHTML = html;
        }

        function clearResults() {
            testResults = [];
            document.getElementById('results').innerHTML = '';
        }

        function clearStorage() {
            localStorage.clear();
            alert('Storage cleared');
        }

        // Test Suite
        function runAllTests() {
            clearResults();
            console.log('Starting test suite...');

            test1_initialization();
            test2_createVersion();
            test3_multipleVersions();
            test4_versionRetrieval();
            test5_versionDeletion();
            test6_versionComparison();
            test7_versionRestoration();
            test8_storageLimit();
            test9_statistics();
            test10_exportImport();

            displayResults();
            console.log('Test suite complete');
        }

        // Test 1: Initialization
        function test1_initialization() {
            const vh = new VersionHistory();
            assert(vh !== null, 'VersionHistory instance created');
            assert(Array.isArray(vh.versions), 'Versions array initialized');
            assertEquals(vh.maxVersions, 10, 'Max versions set to 10');
        }

        // Test 2: Create Version
        function test2_createVersion() {
            localStorage.removeItem('trustMapVersionHistory');
            const vh = new VersionHistory();

            const mapData = {
                relationships: [
                    { id: 1, name: 'Alice' },
                    { id: 2, name: 'Bob' }
                ],
                trustScores: {
                    1: { outward: 1, inward: 2 },
                    2: { outward: 2, inward: 1 }
                }
            };

            const version = vh.createVersion(mapData, 'Test version', true);

            assert(version !== null, 'Version created successfully');
            assertEquals(version.versionNumber, 1, 'Version number is 1');
            assert(version.isManual === true, 'Version marked as manual');
            assertEquals(version.metadata.relationshipCount, 2, 'Relationship count is 2');
        }

        // Test 3: Multiple Versions
        function test3_multipleVersions() {
            localStorage.removeItem('trustMapVersionHistory');
            const vh = new VersionHistory();

            // Create 3 versions
            for (let i = 0; i < 3; i++) {
                vh.createVersion({
                    relationships: Array(i + 1).fill(null).map((_, idx) => ({
                        id: idx,
                        name: `Person${idx}`
                    })),
                    trustScores: {}
                }, `Version ${i + 1}`, false);
            }

            assertEquals(vh.versions.length, 3, 'Three versions created');
            assertEquals(vh.versions[0].versionNumber, 1, 'First version number is 1');
            assertEquals(vh.versions[2].versionNumber, 3, 'Third version number is 3');
        }

        // Test 4: Version Retrieval
        function test4_versionRetrieval() {
            localStorage.removeItem('trustMapVersionHistory');
            const vh = new VersionHistory();

            vh.createVersion({ relationships: [{ id: 1, name: 'Test' }], trustScores: {} }, 'V1', false);
            vh.createVersion({ relationships: [{ id: 1, name: 'Test' }, { id: 2, name: 'Test2' }], trustScores: {} }, 'V2', false);

            const v1 = vh.getVersion(1);
            const v2 = vh.getVersion(2);
            const latest = vh.getLatestVersion();

            assert(v1 !== null, 'Retrieved version 1');
            assert(v2 !== null, 'Retrieved version 2');
            assertEquals(latest.versionNumber, 2, 'Latest version is 2');
            assertEquals(v1.metadata.relationshipCount, 1, 'V1 has 1 relationship');
            assertEquals(v2.metadata.relationshipCount, 2, 'V2 has 2 relationships');
        }

        // Test 5: Version Deletion
        function test5_versionDeletion() {
            localStorage.removeItem('trustMapVersionHistory');
            const vh = new VersionHistory();

            vh.createVersion({ relationships: [], trustScores: {} }, 'V1', false);
            vh.createVersion({ relationships: [], trustScores: {} }, 'V2', false);
            vh.createVersion({ relationships: [], trustScores: {} }, 'V3', false);

            const deleted = vh.deleteVersion(2);

            assert(deleted === true, 'Version deleted successfully');
            assertEquals(vh.versions.length, 2, 'Two versions remain');
            assertEquals(vh.versions[0].versionNumber, 1, 'Version 1 renumbered correctly');
            assertEquals(vh.versions[1].versionNumber, 2, 'Version 3 renumbered to 2');
        }

        // Test 6: Version Comparison
        function test6_versionComparison() {
            localStorage.removeItem('trustMapVersionHistory');
            const vh = new VersionHistory();

            const v1Data = {
                relationships: [
                    { id: 1, name: 'Alice' },
                    { id: 2, name: 'Bob' }
                ],
                trustScores: {
                    1: { outward: 1, inward: 1 },
                    2: { outward: 2, inward: 2 }
                }
            };

            const v2Data = {
                relationships: [
                    { id: 1, name: 'Alice' },
                    { id: 3, name: 'Charlie' }
                ],
                trustScores: {
                    1: { outward: 2, inward: 2 },
                    3: { outward: 1, inward: 1 }
                }
            };

            vh.createVersion(v1Data, 'V1', false);
            vh.createVersion(v2Data, 'V2', false);

            const comparison = vh.compareVersions(1, 2);

            assert(!comparison.error, 'Comparison completed without error');
            assertEquals(comparison.differences.added.length, 1, 'One relationship added');
            assertEquals(comparison.differences.removed.length, 1, 'One relationship removed');
            assertEquals(comparison.differences.added[0], 'Charlie', 'Charlie was added');
            assertEquals(comparison.differences.removed[0], 'Bob', 'Bob was removed');
        }

        // Test 7: Version Restoration
        function test7_versionRestoration() {
            localStorage.removeItem('trustMapVersionHistory');
            const vh = new VersionHistory();

            const originalData = {
                relationships: [{ id: 1, name: 'Original' }],
                trustScores: { 1: { outward: 1, inward: 1 } }
            };

            vh.createVersion(originalData, 'Original', false);
            vh.createVersion({ relationships: [], trustScores: {} }, 'Modified', false);

            const restored = vh.restoreVersion(1);

            assert(restored !== null, 'Version restored successfully');
            assertEquals(restored.relationships.length, 1, 'Restored 1 relationship');
            assertEquals(restored.relationships[0].name, 'Original', 'Restored correct name');
        }

        // Test 8: Storage Limit
        function test8_storageLimit() {
            localStorage.removeItem('trustMapVersionHistory');
            const vh = new VersionHistory();

            // Create 12 versions (exceeds limit of 10)
            for (let i = 0; i < 12; i++) {
                vh.createVersion({
                    relationships: [{ id: i, name: `Person${i}` }],
                    trustScores: {}
                }, `Version ${i + 1}`, false);
            }

            assertEquals(vh.versions.length, 10, 'Only 10 versions retained');
            assertEquals(vh.versions[0].versionNumber, 1, 'Versions renumbered correctly');
            assertEquals(vh.versions[9].versionNumber, 10, 'Latest version is 10');
        }

        // Test 9: Statistics
        function test9_statistics() {
            localStorage.removeItem('trustMapVersionHistory');
            const vh = new VersionHistory();

            vh.createVersion({ relationships: [], trustScores: {} }, 'Manual 1', true);
            vh.createVersion({ relationships: [], trustScores: {} }, 'Auto 1', false);
            vh.createVersion({ relationships: [], trustScores: {} }, 'Manual 2', true);

            const stats = vh.getStatistics();

            assertEquals(stats.totalVersions, 3, 'Total versions is 3');
            assertEquals(stats.manualSaves, 2, 'Manual saves is 2');
            assertEquals(stats.autoSaves, 1, 'Auto saves is 1');
            assert(stats.storageUsed > 0, 'Storage used is greater than 0');
        }

        // Test 10: Export/Import
        function test10_exportImport() {
            localStorage.removeItem('trustMapVersionHistory');
            const vh1 = new VersionHistory();

            vh1.createVersion({ relationships: [{ id: 1, name: 'Test' }], trustScores: {} }, 'Export test', true);

            const exported = vh1.exportVersionHistory();

            assert(exported !== null, 'Export successful');
            assert(exported.length > 0, 'Exported data not empty');

            // Create new instance and import
            localStorage.removeItem('trustMapVersionHistory');
            const vh2 = new VersionHistory();

            const imported = vh2.importVersionHistory(exported);

            assert(imported === true, 'Import successful');
            assertEquals(vh2.versions.length, 1, 'Imported 1 version');
            assertEquals(vh2.versions[0].changeSummary, 'Export test', 'Imported correct data');
        }

        // Auto-run on page load
        window.addEventListener('DOMContentLoaded', () => {
            console.log('Version History Test Suite loaded');
        });
    </script>
</body>
</html>
